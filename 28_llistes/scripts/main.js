var VOTES_PER_BALLOT = 3;var persones = Array();var tableBallots = Array();var ballot = Array();var listSectionHTML = null;var votesSectionHTML = null;Storage.prototype.setObj = function(key, obj) {    return this.setItem(key, JSON.stringify(obj))}Storage.prototype.getObj = function(key) {    return JSON.parse(this.getItem(key))}var resetTableChecks = function() {    confirmation(        "Segur que vols ressetejar aquesta taula?",        "Borrarà totes les butlletes introduides en aquesta fase.",        function() {            resetTable();        }    );};var resetTable = function() {    localStorage.clear();    function createCookie(name,value,days) {        if (days) {            var date = new Date();            date.setTime(date.getTime()+(days*24*60*60*1000));            var expires = "; expires="+date.toGMTString();        }        else var expires = "";        document.cookie = name+"="+value+expires+"; path=/";    }    function readCookie(name) {        var nameEQ = name + "=";        var ca = document.cookie.split(';');        for(var i=0;i < ca.length;i++) {            var c = ca[i];            while (c.charAt(0)==' ') c = c.substring(1,c.length);            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);        }        return null;    }    function eraseCookie(name) {        createCookie(name,"",-1);    }    var cookies = document.cookie.split(";");    for (var i = 0; i < cookies.length; i++){      eraseCookie(cookies[i].split("=")[0]);    }    window.location.reload();};function Person(internal, id, genere, cognoms, nom, vots) {    this.internal = internal;    this.id = id;    this.genere = genere;    this.cognoms = cognoms;    this.nom = nom;    this.vots = vots;}var initialize = function() {    $('.llistaHolder .donesHolder li').each(function() {        var person = new Person(            $(this).data().internal,            $(this).data().id,            $(this).data().genere,            $(this).find('.cognoms').html(),            $(this).find('.nom').html(),            0        );        persones[$(this).data().internal] = person;    });    $('.llistaHolder .homesHolder li').each(function() {        var person = new Person(            $(this).data().internal,            $(this).data().id,            $(this).data().genere,            $(this).find('.cognoms').html(),            $(this).find('.nom').html(),            0        );        persones[$(this).data().internal] = person;    });    listSectionHTML = $('.llistaHolder').html();    votesSectionHTML = $('.votesHolder').html();};$(function() {    initialize();});var submitBallotChecks = function() {    if (ballot.length == 0) {        confirmation(            "Butlleta buida",            "La butlleta té 0 vots.<br>La butlleta és contarà com un vot en blanc. <br>Vols enviar-la?",            function() {                submitBallot();            }        );    } else if (ballot.length < 6) {        confirmation(            "Butlleta incomplerta",            "La butlleta té menys de 6 vots.<br>La butlleta és vàlida i NO contarà com a un vot blanc.<br>Vols enviar-la?",            function() {                submitBallot();            }        );    } else {        submitBallot();    }};var submitBallot = function() {    tableBallots.push(ballot);    resetBallot();    $(".vot-input").focus();};var showError = function(error) {    $('.errors').append('<div class="error">' + error + '</div>');    var $error = $('.errors div').last()    $error.fadeIn();    setTimeout(function() {        $error.fadeOut(function() {            $(this).remove();        });    }, 7000);    $error.click(function() {        $(this).fadeOut(function() {            $(this).remove();        });    })};var confirmation = function(title, text, callbackOK) {    if ($('.confirmations-toggle').prop("checked")) {        dialog(title, text, callbackOK);    } else {        callbackOK();    }};var dialog = function(title, text, callbackOK) {    BootstrapDialog.show({        title: title,        message: text,        buttons: [{            label: 'Si [enter]',            hotkey: 13,            action: function(dialog) {                dialog.close();                callbackOK();            }        }, {            label: 'No [esc]',            action: function(dialog) {                dialog.close();            }        }]    });};var addPersonToBallot = function(from) {    var grouper = "";    var genere = from.data().genere;    switch (genere) {        case "dona":            grouper = "dones";            break;        case "home":            grouper = "homes";            break;        default:            showError("Falta génere");            return;            break;    }    var fromList = $('.llistaHolder .voteList.' + grouper);    var targetList = $(".votesHolder .voteList." + grouper);    if (targetList.find('li').size() >= VOTES_PER_BALLOT) {        showError("El limit de vots per butlleta és de " + VOTES_PER_BALLOT);        return;    }    if (targetList.find(" li[data-id='" + from.data().id + "']").size()) {        showError("No es pot afegir aquest vot perquè ja existeix");        return;    }    if (targetList.find('li').size() == VOTES_PER_BALLOT) {        fromList.find('li').addClass("limit");    }    targetList.find("li.disabled").remove();    var cloned = from.clone();    cloned.appendTo(targetList);    from.addClass("selected");    from.addClass("disabled");    ballot.push(persones[from.data().internal]);    $(".vot-input").focus();}var getNumber = function(keyCode) {    if (keyCode < 48 || keyCode > 57) {        return false;    }    return parseInt(keyCode - 48);};var resetBallot = function() {    ballot = Array();    $('.llistaHolder').html(listSectionHTML);    $('.votesHolder').html(votesSectionHTML);}var deleteLast = function() {    tableBallots.pop();    $(".vot-input").focus();}var resetOrDeleteLast = function() {    if (ballot.length) {        //borrar esta        resetBallot();    } else {        if(tableBallots.length == 0){            showError("No s'ha introduït cap butlleta en aquesta taula");            return;        }        lastElement = tableBallots[tableBallots.length-1];        var confirmationText = "<div>Estas segur que vols borrar l'anterior entrada?<div><ul>";        $(lastElement).each(function(){            confirmationText += "<li>"+$(this)[0].nom+" "+$(this)[0].cognoms+"</li>";        });        confirmationText += "</ul>";        confirmation(            "borrar l'anterior entrada",            confirmationText,            callbackOK = function() {                deleteLast();            }        );    }};var closeTable = function() {    if (ballot.length) {        showError("Hi ha una butlleta a mig enviar. Acaba la butlleta primer si us plau");        return;    }    if (tableBallots.length == 0) {        showError("No s'ha introduit cap butlleta. No es pot tancar la taula");        return;    }    $.ajax({            url: "controllers/closeTable.php",            type: "GET",            data: {                "tableBallots": JSON.stringify(tableBallots)            },            dataTye: "json"        })        .done(function(data) {            window.location.reload();        });}var keyDownController = function(event) {    event.preventDefault();    if (!$('body.vote').size()) {        //només a la secció de votacions        return false;    }    var input = $("input[name='vot']");    var currentVal = null;    if (input.val() == "") {        currentVal = 0;    } else {        currentVal = parseInt(input.val());    }    //numero    var number = getNumber(event.keyCode);    if (number !== false) {        if (currentVal == 0) {            input.val(number);        } else if (currentVal > 0 && currentVal < 10) {            currentVal = currentVal * 10 + number;            if ($(".llistaHolder .voteList li[data-internal='" + currentVal + "']").length == 1) {                addPersonToBallot($(".voteList li[data-internal='" + currentVal + "']"));                input.val("");            } else {                input.val("");                showError("No existeix aquesta persona");                return;            }        } else {            input.val("");            showError("El numero introduït no és correcte");            return;        }    }    //suprimir    if (event.keyCode == 46) {        resetOrDeleteLast();    }    //enter    if (event.keyCode == 13) {        event.preventDefault();        submitBallotChecks();    }};$(function() {    $("input[name='vot']").keydown(function(event) {        keyDownController(event);    });    $('body.vote').on('click','.voteList li',function(){        if($(this).hasClass('disabled')){            return;        }        addPersonToBallot($(this));    });});$(function() {    $('.ballot-form').submit(function(event) {        event.preventDefault();        submitBallotChecks();    });    $('.close-button').click(function(event) {        event.preventDefault();        closeTable();    });    $('.delete-button').click(function(event) {        event.preventDefault();        resetOrDeleteLast();    });    $('.refresh-form').submit(function(event) {        event.preventDefault();        window.location.reload();    });    $('.reset-button').click(function(event) {        event.preventDefault();        resetTable();    });    $('.two-columns-toggle').change(function() {        if($(this).prop('checked')){            $('body').addClass("oneColumn");        }        else {            $('body').removeClass("oneColumn");        }    });});